/*!
 * 
 *     MCAFEE RESTRICTED CONFIDENTIAL
 *     Copyright (c) 2025 McAfee, LLC
 *
 *     The source code contained or described herein and all documents related
 *     to the source code ("Material") are owned by McAfee or its
 *     suppliers or licensors. Title to the Material remains with McAfee
 *     or its suppliers and licensors. The Material contains trade
 *     secrets and proprietary and confidential information of McAfee or its
 *     suppliers and licensors. The Material is protected by worldwide copyright
 *     and trade secret laws and treaty provisions. No part of the Material may
 *     be used, copied, reproduced, modified, published, uploaded, posted,
 *     transmitted, distributed, or disclosed in any way without McAfee's prior
 *     express written permission.
 *
 *     No license under any patent, copyright, trade secret or other intellectual
 *     property right is granted to or conferred upon you by disclosure or
 *     delivery of the Materials, either expressly, by implication, inducement,
 *     estoppel or otherwise. Any license under such intellectual property rights
 *     must be expressed and approved by McAfee in writing.
 *
 */(()=>{"use strict";const e=0,t="PRINT_IN_BACKGROUND",i={NONE:0,INFO:1,ERROR:2,WARN:3,DEBUG:4,ALL_IN_BACKGROUND:99},o=1,r=2,s=3,n=4,a={BACKGROUND:"BACKGROUND",CONTENT:"CONTENT",TELEMETRY:"TELEMETRY"},d={DEFAULT:"color: #000000; font-weight: normal; font-style:normal; background: #FFFFFF;",BACKGROUND:"color: #8D0DBA; font-weight: bold; background: #FFFFFF;",CONTENT:"color: #F54A26; font-weight: bold; background: #FFFFFF;",TELEMETRY:"color: #147831; font-weight: bold; background: #FFFFFF;"};const l=new class{constructor(){this.storageChecked=!1,this.logLevel=null,this.queue=[];const t="MCLOGLEVEL";chrome?.storage?.local.get([t]).then(o=>{const r=Object.values(i).includes(o[t]);this.logLevel=r?o[t]:e,this.logLevel!==i.NONE&&this.queue.forEach(({callback:e,message:t,processType:i})=>{e(t,i)}),this.queue=[],this.storageChecked=!0})}log(e,t=null){this.storageChecked?this.processLog(e,o,t,this.logLevel):this.queue.push({callback:this.log.bind(this),message:e,processType:t})}error(e,t=null){this.storageChecked?this.processLog(e,r,t,this.logLevel):this.queue.push({callback:this.error.bind(this),message:e,processType:t})}warn(e,t=null){this.storageChecked?this.processLog(e,s,t,this.logLevel):this.queue.push({callback:this.warn.bind(this),message:e,processType:t})}debug(e,t=null){this.storageChecked?this.processLog(e,n,t,this.logLevel):this.queue.push({callback:this.debug.bind(this),message:e,processType:t})}processLog(e,o,s,n){if(n===i.NONE)return;let d="chrome-extension:"===location.protocol?a.BACKGROUND:a.CONTENT;s&&a[s]&&(d=s);const l=this.formatDateWithMilliseconds(new Date),c=o===r?e:`%c[${d} ${l} ]: %c${e}`;d===a.CONTENT&&this.logLevel===i.ALL_IN_BACKGROUND&&chrome.runtime.sendMessage({command:t,logMessage:c,processType:d,logType:o,logLevel:n}),this.printLog(c,d,o,n)}formatDateWithMilliseconds(e){return`${new Intl.DateTimeFormat("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0}).format(e)}.${e.getMilliseconds().toString().padStart(3,"0")}`}printLog(e,t,a,l){const c=d.DEFAULT,u=d[t]||c;if(l>=i.ERROR&&a===r&&console.error(e),l>=i.INFO&&a===o&&console.log(e,u,c),l>=i.WARN&&a===s){const t="color: #FFA500; font-family: sans-serif; font-weight: bolder; text-shadow: #000 1px 1px;";console.log(`%cWARN - ${e}`,t,u,c)}if(l>=i.DEBUG&&a===n){const t="color: #FF33D7; font-family: sans-serif; font-weight: bolder; text-shadow: #000 1px 1px;";console.log(`%cDEBUG - ${e}`,t,u,c)}}},c=(e,t=null,i)=>{"function"==typeof i?chrome.runtime.onMessage.addListener((o,r,s)=>{if(r.id===chrome.runtime.id&&"object"==typeof o&&!Array.isArray(o)&&o?.ipcId===e)return i({promises:t,request:o,sender:r,sendResponse:s})}):l.error("Provided with invalid callback function")},u=e=>{"undefined"!=typeof document&&null!==document&&("complete"===document.readyState||"loading"!==document.readyState&&!document.documentElement.doScroll?e():document.addEventListener("DOMContentLoaded",e))},m=(e=document.body,t={},i={})=>{new MutationObserver(e=>{for(const i of e){"attributes"===i.type&&t.attributeChangedCb&&t.attributeChangedCb(i.target);for(const e of i.addedNodes)t.addedNodeCb&&t.addedNodeCb(e);for(const e of i.removedNodes)t.removedNodeCb&&t.removedNodeCb(e)}}).observe(e,{childList:!0,subtree:!0,...i})},h=(e,t,i={})=>{const{add:o=!1,remove:r=!1}=i;if(!Array.isArray(t))return!1;for(let i=0;i<t.length;i+=1){if(t[i].node.isSameNode(e))return r&&t.splice(i,1),!0}return o&&t.push({node:e,url:window.location.href}),!1},g=e=>{try{return cloneInto(e,wrappedJSObject)}catch(t){return e}},p=()=>{const e=new Uint8Array(24);crypto.getRandomValues(e);let t=Date.now().toString()+Math.random().toString().substring(2);for(let i=0;i<24;++i)t+=e[i].toString();let i="";for(let e=0;e<36;++e)if(8===e||13===e||18===e||23===e)i+="-";else{i+=t[Math.floor(Math.random()*t.length)]}return`{${i}}`},f=()=>`m${(Math.random()+1).toString(36).slice(2)}`,v=(e,t,i)=>{const o=async(t,r)=>{await i()?r(!0):t<=0?r(!1):setTimeout(()=>{o(t-1,r)},e)};return new Promise(e=>{o(t,e)})};class S{constructor(e,t){this.pingCommand=e,this.ipcId=t,this.mainFunction="function"==typeof this.main?((e,t)=>{let i;return(...o)=>(e&&(i=e.apply(t||void 0,o),e=null,t=null),i)})(this.main,this):()=>{},this.basePingListener(),this.addIdentifier()}basePingListener(){c(this.ipcId,null,({request:e,sendResponse:t})=>{const{command:i,...o}=e;if(i===this.pingCommand)return l.debug(`File Injection [pinged]: Received ${i} command`),t({content:!0}),"function"==typeof this.mainFunction&&this.mainFunction(o),"function"==typeof this.callback&&this.callback(),!0})}addIdentifier(){u(()=>{const e=document.createElement("span");e.id=this.pingCommand,e.style.cssText="display:none",document.body.appendChild(e)})}}const w=async(e,t,i,o)=>{try{chrome.tabs.sendMessage(o,{ipcId:e,command:t,...i},{},()=>{chrome.runtime.lastError})}catch(e){l.warn(`[broadcast] Unexpected error when calling command: "${t}", err: ${e.message}`)}},b=(e,t,i,o,r=null)=>{if(!chrome.tabs)throw new Error('"tabs" permission not set in manifest.');const s={};return"number"==typeof r&&(s.frameId=r),chrome.tabs.sendMessage(o,{ipcId:e,command:t,...i},s)},y="MC_SHADOW_PROCESSED",E="MC_CONTENT_SCRIPT_INITIALIZED",A="MB_PROCESS_SHADOW_BY_ID",M="MB",T=1,k="pause",R="seeked",P="ended",C="softend",N="ratechange",B="volumechange",L={[N]:1,[B]:2,[R]:3,[P]:3,[C]:4,[k]:1},I=(e,t={},i)=>(async(e,t,i={},o={})=>{try{if(o?.tabId){const{tabId:r,frameId:s}=o;return await b(e,t,i,r,s)}if(o?.broadcast){const r=await chrome.tabs.query({}),{broadcastIgnoreId:s=[]}=o;return r.filter(({id:e})=>!s.includes(e)).forEach(({id:o})=>{w(e,t,i,o)}),!0}return await chrome.runtime.sendMessage({ipcId:e,command:t,...i})}catch(e){return l.warn(`Unexpected error when calling command: "${t}", err: ${e.message}`),null}})(M,e,t,i),$="NATIVE_STREAM",D="AUDIO_NODE_REMOVED",O="MB_SEND_VIDEO_EVENTS_TO_NATIVE",F="GET_SOCKET_DETAILS",W="VIDEO_STARTED",_="MB_ENABLEMENT_STATE",U="STOP_STREAMING",q="GET_STREAMING_AUDIOS",V="PING_CONTENT_MB_MAIN";class x{constructor(){this.audioInfos=[]}add(e){const t={id:p(),element:e,recorder:null,websocket:null,listening:!1,capturing:!1,tabStream:null,canvas:null,src:null,workletNodePort:null,pageElement:!1,stopstreamTriggered:!1,streamId:0,totalSend:0,isAd:null,totalRecordingTime:0,stoppedRecordingTimer:!1,lastRecordedSrc:null};return this.audioInfos.push(t),t}get(e){for(const t of this.audioInfos)if(t.element.isSameNode(e))return t;return null}getById(e){for(const t of this.audioInfos)if(t.id===e)return t;return null}getAll(){return this.audioInfos}}class G{constructor(){window.audioMonitor=new x}init(e,t=!0){this.featureEnabled=t,this.guid=e.guid,this.browserDetails=e.browserDetails,this.secret=e.secret,this.port=e.port,this.samplerate=e.settings.samplerate,this.chunksize=e.settings.chunksize,this.isOnAudioRecorder=e.settings.isOnAudioRecorder,this.uniqueMessageId=e.uniqueMessageId,this.windowid=e.windowid,this.tabid=e.tabid,this.frameid=e.frameid,this.workletUrl=e.workletUrl,this.processor=e.settings.processor,this.dfdActiveTabRecording=e.settings.dfdActiveTabRecording,this.dfdRecordingTimer=e.settings.dfdRecordingTimer,this.socketUri=`ws://127.0.0.1:${this.port}/`,this.version=1,this.audioAvailabilityTimeLimit=5e3,this.audioAvailbilityPollingTime=20,this.audioAvailbilityWaitingThresholdWarning=500,this.stopTimeoutLimit=5e3,this.videoEventTimeoutId={volumechange:null,pause:null,seeked:null},this.cachedMetadata={}}async monitorElement(e){let t=window.audioMonitor.get(e);t||(t=window.audioMonitor.add(e),t.listening=!1),t.listening||this.addListeners(t);await v(500,3,()=>H.isPlaying(e))&&(t.listener="monitorElement",this.startStream(t))}addListeners(e){e.listening=!0;const{element:t}=e;["play","playing"].forEach(i=>{t.addEventListener(i,()=>{e.listener=i,this.startStream(e)})}),["pause","stalled","ended","error","abort"].forEach(i=>{t.addEventListener(i,async()=>{this.createPayloadAndSendEvent(e,i),e.listener=i,("pause"!==i||"pause"===i&&(!e.element.paused||e.element.paused&&e.element.ended))&&(e.videoEnded=!0),await this.stopStream(e)})}),t.addEventListener("volumechange",async()=>{this.createPayloadAndSendEvent(e,"volumechange"),await e.startPromise,e.listener="volumechange",H.isPlaying(t)?this.startStream(e):this.stopStream(e)}),t.addEventListener("loadeddata",async()=>{await v(500,3,()=>H.isPlaying(t))&&(e.listener="loadeddata",this.startStream(e))}),this.dfdActiveTabRecording&&"cpu"===this.processor?.toLocaleLowerCase()&&document.addEventListener("visibilitychange",()=>{this.onVisibilityChange(e)}),["ratechange","seeked"].forEach(i=>{t.addEventListener(i,()=>{this.createPayloadAndSendEvent(e,i)})})}onVisibilityChange(e){"hidden"===document.visibilityState?(e.listener="visibilitychange",l.log(`[MB:onVisibilityChange] visibility state: ${document.visibilityState}, stopping stream`),this.stopStream(e)):H.isPlaying(e.element)&&(e.listener="visibilitychange",l.log(`[MB:onVisibilityChange] visibility state: ${document.visibilityState}, starting stream`),this.startStream(e))}preventRecordingReqSatisfy(e){return(!0===this.dfdActiveTabRecording&&"cpu"===this.processor?.toLocaleLowerCase()&&"hidden"===document.visibilityState||!0===e.stoppedRecordingTimer)&&(l.log(`[MB:preventRecordingReqSatisfy] preventing to start stream recording because of visibility state: ${document.visibilityState} or stoppedRecordingTimer: ${e.stoppedRecordingTimer}`),H.isStreamAlreadyStarted(e)&&this.stopStream(e),!0)}createPayloadAndSendEvent(e,t){const{element:i}=e,o={duration:i.duration??-1,cachekey:H.getCacheKey(e.element.currentSrc),srcurl:i.currentSrc||""};clearTimeout(this.videoEventTimeoutId.pause),this.videoEventTimeoutId.pause=null,t===k?this.waitMilliSecondsAndSendEvent(t,()=>{i.paused?this.sendVideoEvent(t,o):l.log("[MB:createPayloadAndSendEvent] Pause event triggered but video is not paused")}):t===B||t===R?this.waitMilliSecondsAndSendEvent(t,()=>{this.sendVideoEvent(t,o)}):this.sendVideoEvent(t,o)}waitMilliSecondsAndSendEvent(e,t,i=1e3){Object.prototype.hasOwnProperty.call(this.videoEventTimeoutId,e)&&"function"==typeof t?(clearTimeout(this.videoEventTimeoutId[e]),this.videoEventTimeoutId[e]=setTimeout(()=>{this.videoEventTimeoutId[e]=null,t()},i)):l.log(`[MB:waitMilliSecondsAndSendEvent] Invalid event name or callback function for event: ${e}`)}sendVideoEvent(e,t){if(e===R||e===N||e===B)t.resetreason=L[e];else if(e===k)t.pausereason=L[e];else{if(e!==P&&e!==C)return;t.endreason=L[e]}l.log(`[MB:sendVideoEvent] Sending video event: ${e} with payload: ${JSON.stringify(t)}`),I(O,{payload:t})}streamPlayingAudio(){window.audioMonitor.getAll().forEach(e=>this.monitorElement(e.element))}async startStream(e){if(!e)return l.error("[MB:startStream] error monitoringItem not defined"),!1;if(!this.featureEnabled)return l.log("[MB:startStream] MB feature is disabled"),!1;I(W);const t=e.element.src||e.element.currentSrc;if(e.lastRecordedSrc?e.lastRecordedSrc!==t&&(e.lastRecordedSrc=t,e.stoppedRecordingTimer=!1,e.totalRecordingTime=0):e.lastRecordedSrc=t,this.preventRecordingReqSatisfy(e))return!1;if(H.isStreamAlreadyStarted(e))return l.debug("[MB:startStream] stream already started"),!1;e.stopPromise&&(l.warn("[MB:startStream] Waiting for stopStream to complete."),await e.stopPromise,l.log("[MB:startStream] Waiting completed stopStream has completed.")),e.startPromise=(e.startPromise||Promise.resolve()).then(async()=>!H.isStreamAlreadyStarted(e)&&(await this.handleStartStreamPromise(e),!0));const i=await e.startPromise;return e.startPromise=null,i}async handleStartStreamPromise(e){if(!this.featureEnabled)return l.log("[MB:handleStartStreamPromise] feature not enabled"),!1;l.log("[MB:handleStartStreamPromise] startStream called with monitoring object:"),l.log(JSON.stringify(e)),e.url=window.location.href;const t=e.src;if(this.shouldStopPreviousStream(e)){l.warn(`[MB:handleStartStreamPromise] Previous stream  ${t} is in progress, need to stop it before proceeding...`),await this.stopStream(e,!1);const i=e.element.src||e.element.currentSrc;e.src=i,e.videoEnded=!1}if(e.capturing)return!0;const i=f(),o=await this.initializeStream(e);if(!o||!this.samplerate)return await this.handleStreamError(e,"[MB:handleStartStreamPromise] stream is null or samplerate is not set, stopping the stream..."),!1;const r=e.element,s=()=>{const e=r.src||r.currentSrc,t={duration:r.duration,srcurl:e};this.cachedMetadata[i]=t,r.removeEventListener("loadedmetadata",s)};e.element.addEventListener("loadedmetadata",s);return await this.setupAudioProcessing(o,e,i)?(this.initCommChannel(e),!0):(await this.handleStreamError(e,`[MB:handleStartStreamPromise] Error in Audio Setup, returning for src ${e.src}`),!1)}async handleStreamError(e,t){return l.error(`[MB:handleStreamError] ${t}`),await this.stopStream(e,!1),!1}async createEventPromise(e,t,i){const{src:o}=t,r=new Promise(r=>{const s=t=>{const s=this.checkAudioTracks(e);s&&!i.resolved?(l.debug(`[MB:onLoadedMetadata] Audio tracks found first by Events ${t.type} for src ${o}`),i.resolved=!0,n()):n(t.type),r(s)},n=e=>{e?t.element.removeEventListener(e,s):(t.element.removeEventListener("canplay",s),t.element.removeEventListener("loadedmetadata",s))};t.element.addEventListener("canplay",s),t.element.addEventListener("loadedmetadata",s)}),s=new Promise((e,t)=>setTimeout(()=>{i.resolved||(i.resolved=!0,t(new Error("[MB:timeoutPromise] No audio tracks available after waiting for events")))},this.audioAvailabilityTimeLimit));return Promise.race([r,s])}async createPollPromise(e,t){const i=performance.now();let o=null;for(;performance.now()-i<this.audioAvailabilityTimeLimit;){if(o=this.checkAudioTracks(e),o&&!t.resolved){t.resolved=!0;break}await H.delay(this.audioAvailbilityPollingTime)}if(!t.resolved)throw t.resolved=!0,new Error("[MB:createPollPromise] No audio tracks available after polling");return o}checkAudioTracks(e){const t=e.getAudioTracks();return t&&t.length>0?t:null}async checkAudioTrackAvailabilityHybrid(e,t){try{const i={resolved:!1},o=this.createEventPromise(e,t,i),r=this.createPollPromise(e,i);return await Promise.race([o,r])}catch(e){return l.error(`[MB:checkAudioTrackAvailabilityHybrid] ${e}`),!1}}async initCommChannel(e){try{const t=e.src;await this.startWebSocket(e),l.log(`[MB:initCommChannel] startWebSocket call completed for src ${t}`)}catch(e){l.error(`[MB:initCommChannel] Failed to connect through websocket, defaulting to fallback messaging, error: ${e?.message}`)}}async initializeStream(e){const{element:t,tabStream:i}=e;try{const o=i||(t.captureStream?t.captureStream():t.mozCaptureStream());return e.capturing=!0,e.stopstreamTriggered=!1,o}catch(e){return l.warn(`[MB:initializeStream] Failed to capture stream: ${e.message}`),null}}shouldStopPreviousStream(e){const t=e.element.src||e.element.currentSrc;if(e.src){if(e.src!==t)return!0}else e.src=t,e.videoEnded=!1,e.id=H.extractGUIDFromURL(e.src)||e.id;return!1}async measureOperation(e){const t=performance.now();return{result:await e(),duration:performance.now()-t}}async logPerformanceMessage(e,t,i){const o=[`Took ${e} milliseconds in getting audio tracks`,e>i?" so might be initial audio loss":"",` in ${t}`].join("");l.debug(`[MB:logPerformanceMessage] ${o}`)}async checkAudioAvailability(e,t){const{result:i,duration:o}=await this.measureOperation(()=>this.checkAudioTrackAvailabilityHybrid(e,t));return!!i&&(this.logPerformanceMessage(o,t.src,this.audioAvailbilityWaitingThresholdWarning),!0)}async setupAudioProcessing(e,t,i){if(!await this.checkAudioAvailability(e,t))return!1;const o=await this.setupAudioContext(e,t);if("running"!==o.state&&t?.element?.muted)return l.warn(`[MB:setupAudioProcessing] Audio context has ${o.state} state and audio muted: ${t?.element?.muted}, stopping stream`),t.capturing=!1,!1;try{this.determineAds(t),await this.initializeWorklet(o,e,t,i)}catch(e){return l.error(`[MB:setupAudioProcessing] Failed to initialize AudioWorklet for ${t.src}, err: ${e.message}`),!1}return!0}async setupAudioContext(e,t){let i=this.samplerate;t.element.captureStream||this.rewireAudioForCompatibility(e,i);const o=new AudioContext({sampleRate:i});return t.audioContext=o,t.defaultSampleRate=o.sampleRate,t.defaultChannels=1,o}determineAds(e){l.debug(`[MB:determineAds]: start is Ad: ${e.isAd}`);const t=H.isYoutubeAd();e.isAd&&!t&&(l.debug("[MB:determineAds]: video no longer has Ads, removing banner"),this.handleAudioRemoved([e.element],[])),l.debug(`[MB:determineAds]: isAd set: ${t}`),e.isAd=t}rewireAudioForCompatibility(e,t){const i=new AudioContext({sampleRate:t});i.createMediaStreamSource(e).connect(i.destination)}async initializeWorklet(e,t,i,o){const r=await this.createWorklet(e,t);i.workletNode=r,i.workletNodePort=r.port,await this.startWorklet(i,o),l.log(`[MB:initializeWorklet] Worklet has been started for src ${i.src}`),i.workletNodePort.onmessage=e=>{this.handleWorkletMessage(i,e.data)}}async startWorklet(e,t){e.workletNodePort.postMessage({state:"start",sampleRate:this.samplerate,chunksize:this.chunksize,guid:t})}async createWorklet(e,t){await e.audioWorklet.addModule(this.workletUrl);const i=e.createMediaStreamSource(t),o=new AudioWorkletNode(e,"pcm-processor");return i.connect(o),o}handleWorkletMessage(e,t){if("stop"!==t.state)if(this.featureEnabled){if((e.capturing||t.isLast)&&t.buffer&&t.buffer.byteLength>0){if(e.stopstreamTriggered||(e.totalSend+=t.buffer.byteLength),this.stopRecordingTimeElapsed(e),this.isOnAudioRecorder)return void this.downloadAudioRawData(t);if(e.streamId++,!this.isElementDataStillValid(e,t))return;const i=this.getMetadata(e,t);if(!i)return;e.websocket&&e.websocket.readyState===WebSocket.OPEN?this.streamWebSocket(e,t,i):this.streamNativeMessage(e,t,i)}}else this.stopStream(e)}isElementDataStillValid(e,t){const{guid:i,isLast:o,firstChunk:r}=t,{duration:s=0,currentSrc:n="",currentTime:a=0}=e.element;if(isNaN(a)||"number"!=typeof a||0===a)return l.log(`[MB:isElementDataStillValid] invalid currentTime=${a}, on currentSrc=${n}`),!1;if(isNaN(s)||"number"!=typeof s||0===s)return l.log(`[MB:isElementDataStillValid] invalid duration=${s}, on currentSrc=${n}`),!1;const d=this.cachedMetadata[i];if(!d)return!0;if(o){if(l.debug("[MB:isElementDataStillValid] clearing cache as this is the last chunk"),delete this.cachedMetadata[i],r)return l.log("[MB:isElementDataStillValid] Will not process further since first and last chunk are too short for analysis"),!1;const{duration:e,srcurl:t}=d;if(n!==t)return l.log(`[MB:isElementDataStillValid] "src" mismatch - ${n} != ${t}. Will not process further.`),!1;if(e!==s)return l.log(`[MB:isElementDataStillValid] "duration" mismatch - ${e} != ${s}. Will not process further.`),!1}return!0}stopRecordingTimeElapsed(e){this.dfdRecordingTimer&&-1!==this.dfdRecordingTimer&&(e.totalRecordingTime+=4,l.log(`[MB:stopRecordingTimeElapsed] totalRecordingTime: ${e.totalRecordingTime}`),e.totalRecordingTime>=this.dfdRecordingTimer&&(l.log("[MB:stopRecordingTimeElapsed] total recording time passed"),this.createPayloadAndSendEvent(e,C),e.stoppedRecordingTimer=!0,e.listener="stoppedRecordingTimer",this.stopStream(e)))}async stopStream(e,t=!0){e&&(t&&e.startPromise&&(l.log(`[MB:stopStream] Stop Stream: The START STREAM is still in progress for ${e.src}`),await e.startPromise),e.stopPromise?l.warn(`[MB:stopStream] An Existing Stop Stream is in progress; so it will skip the stop operation for src ${e.src}`):(e.stopPromise=this.handleStopStreamPromise(e),await this.waitForStopPromiseWithTimeout(e),e.stopPromise=null))}handleStopStreamPromise(e){return new Promise(t=>{const i=async o=>{"stop"===o.data.state&&(l.log(`[MB:handleStopStreamPromise] OnStop will be called to stop sockets and clean up audio resources for src ${e.src}.`),e.workletNodePort?.removeEventListener("message",i),await this.onClose(e),e.stopPromise=null,t())};e.workletNodePort?(e.workletNodePort.addEventListener("message",i),e.workletNodePort.postMessage({state:"stop",videoEnded:e.videoEnded})):(l.warn(`[MB:handleStopStreamPromise] monitoringItem.workletNodePort is null, not registering stop message event for src ${e.src}`),t(),e.stopPromise=null)})}async waitForStopPromiseWithTimeout(e){const t=this.stopTimeoutLimit||5e3,i=new Promise((i,o)=>{setTimeout(()=>o(new Error(`[MB:waitForStopPromiseWithTimeout] Stop operation timed out for src: ${e.src}`)),t)});try{l.log(`[MB:waitForStopPromiseWithTimeout] Going to wait for stop promise to complete for src ${e.src}`),await Promise.race([e.stopPromise,i])}catch(e){l.error(`[MB:waitForStopPromiseWithTimeout] Stop Stream error: ${e.message}`),this.onClose()}}async startWebSocket(e){const t=e.src;return new Promise((i,o)=>{const r=new WebSocket(this.socketUri);r.onopen=()=>{e.websocket=r,l.log("[MB:websocket.open] success."),i()},r.onerror=i=>{l.error(`[MB:websocket.onerror] Websocket error for src ${t} : ${i.message}`),e.listener="onerror",e.websocket=null,o(i)},r.onclose=()=>{l.log(`[MB:websocket.onclose] Websocket closed for src ${t}`)}})}handShakeWebSocket(e,t){const{id:i}=e,{topurl:o,isAd:r,cachekey:s,srcurl:n}=t,a={version:this.version,topurl:o,guid:this.guid,secretcode:this.secret,frameid:this.frameid,tabid:this.tabid,windowid:this.windowid,defsamplerate:e.defaultSampleRate,defchannels:e.defaultChannels,id:i,srcurl:n,cachekey:s,isAd:r,servertype:T,...this.browserDetails},d=JSON.stringify(a);l.log(`[MB:handShakeWebSocket] socket handshake request: ${d}`),e.websocket.send(d)}getElementMetadata(e){const{element:t}=e,i=H.getCacheKey(e.element.currentSrc),o=H.isYoutubeAd();e.isAd=o;const{totalVideoFrames:r=0,droppedVideoFrames:s=0}=t.getVideoPlaybackQuality()||{},n=t.getAttribute("type")??null;return{cachekey:i,curtime:t.currentTime??-1,duration:t.duration??-1,muted:t.muted??null,volume:t.volume??null,topurl:document.location.href,type:n,totalvideoframes:r,droppedvideoframes:s,playbackrate:t.playbackRate??null,isad:o,isAd:o}}getMetadata(e,t){const{isLast:i,videoEnded:o,totalChannels:r}=t,s=this.getElementMetadata(e),{element:n,id:a,defaultSampleRate:d,defaultChannels:c,streamId:u,stopstreamTriggered:m}=e,h={id:a,islastchunk:i||!1,videoended:o||!1,srcurl:n.currentSrc||"",browserurllocale:navigator.language,defsamplerate:d,defchannels:c,streamid:u,stopstreamtriggered:m,totalchannels:r,...s},g=document?.querySelector("div.ytp-menuitem.ytp-audio-menu-item"),p=g?.querySelector(".ytp-menuitem-label")?.innerText?.includes("Audio track")?g?.querySelector(".ytp-menuitem-content")?.textContent:null;h.language=p;const f=document?.querySelector("div.ytp-menuitem.ytp-drc-menu-item > .ytp-menuitem-label"),v=(e=>{if("string"!=typeof e||""===e)return null;const t=e.trim().toLowerCase();return"true"===t||"false"!==t&&null})("Stable Volume"===f?.textContent?f?.parentElement?.getAttribute("aria-checked"):null);h.stablevolume=v;try{h.data=JSON.stringify(h)}catch(e){return l.error(`[MB:getMetadata] failed to JSON parse metadataResp into data, err ${e.message}`),null}return h}streamWebSocket(e,t,i){const{buffer:o}=t,{streamId:r,stopstreamTriggered:s,websocket:n,totalSend:a}=e;t.firstChunk&&this.handShakeWebSocket(e,i),n.send(JSON.stringify(i)),s||n.send(o),l.log(`[MB:streamWebSocket] buffered: ${n.bufferedAmount}, total: ${a}, streamid: ${r}, stopstreamtriggered: ${s}, metadata: ${JSON.stringify(i)}`)}streamNativeMessage(e,t,i){const{buffer:o}=t,{streamId:r,stopstreamTriggered:s,totalSend:n}=e,a=(e=null)=>{const t={...i,version:this.version,tabid:this.tabid,frameid:this.frameid,windowid:this.windowid,data64:e};I($,{payload:t}),l.log(`[MB:nativeStream] total: ${n}, streamid: ${r}, stopstreamtriggered: ${s}`)};if(s)a();else if(o){const e=(e=>{let t="";const i=new Uint8Array(e),o=i.byteLength;for(let e=0;e<o;e++)t+=String.fromCharCode(i[e]);return`data:audio/pcm;base64,${btoa(t)}`})(o);a(e)}}getStreamingAudios(e=null){const t=[],i=window?.audioMonitor?.audioInfos||[];if(!i.length)return l.error("[MB:getStreamingAudios] audioInfos is empty"),t;for(let o=0;o<i.length;o+=1){const r=i[o],s={topurl:document.location.href,frameid:this.frameid,tabid:this.tabid,windowid:this.windowid,id:r.id,srcurl:r.element.currentSrc||"",curtime:r.element.currentTime??-1,duration:r.element.duration??-1,cachekey:H.getCacheKey(r.element.currentSrc),pageElement:r.pageElement};if(e){if(r.id===e){t.push(s);break}}else r.capturing&&t.push(s)}return t}async onClose(e){e.websocket&&(l.log(`[MB:OnClose] close sockets for src: ${e.src}`),e.websocket?.close(),e.websocket=null),await this.cleanUp(e)}async cleanUp(e){e.capturing=!1,e.src=null,e.streamId=0,e.totalSend=0,e.totalSend=0,this.cleanUpWorkletNode(e),await this.closeAudioContext(e),l.log("[MB:cleanUp] Stop Stream: Audio context and worklet node have been cleaned up"),this.handleBannercleanUp(e)}cleanUpWorkletNode(e){e.workletNodePort&&(e.workletNodePort.onmessage=null,e.workletNodePort=null),e.workletNode&&(e.workletNode.disconnect(),e.workletNode=null)}async closeAudioContext(e){e.audioContext&&(await e.audioContext.close(),e.audioContext=null)}handleBannercleanUp(e){"abort"===e.listener&&e.url!==window.location.href&&this.handleAudioRemoved([e.element],[]),"play"===e.listener&&e.src!==e.element.currentSrc&&this.handleAudioRemoved([e.element],[])}handleAudioFound(e,t){[...e,...t].forEach(e=>this.monitorElement(e))}handleAudioRemoved(e,t){[...e,...t].forEach(e=>{const t=window?.audioMonitor.get(e)||null;if(t){const e={tabId:this.tabid,frameId:this.frameid,id:t.id};I(D,{payload:e})}})}downloadAudioRawData(e){l.log("[MB:downloadAudioRawData] start downloading raw audio data");const t=new Blob([e.buffer],{type:"audio/pcm"}),i=URL.createObjectURL(t),o=document.createElement("a");o.style.display="none",o.href=i,o.download=`${document.location.href}.pcm`,document.body.appendChild(o),o.click(),URL.revokeObjectURL(i),document.body.removeChild(o),l.log("[MB:downloadAudioRawData] finish downloading raw audio data")}handleCanvasFound(e){e.forEach(e=>this.attachCanvasListener(e))}attachCanvasListener(e){let t=window.audioMonitor.get(e);t||(t=window.audioMonitor.add(e),t.listening=!1),t.listening||(e.addEventListener(this.uniqueMessageId,({detail:e={}})=>{"MB_PROCESS_CANVAS"===e.command&&this.handleCanvasListener(e,t)}),t.listening=!0)}handleCanvasListener(e,t){const{event:i="",id:o,data:r}=e;if("ATTACHED_ID"===i)t.id=o,t.pageElement=!0;else if("CAPTURE_START"===i)t.capturing=!0;else if("CAPTURE_STOP"===i)t.capturing=!1;else if("NATIVE_STREAM"===i)I($,{payload:r});else if("VIDEO_REMOVED"===i)this.handleAudioRemoved([t.element],[]);else if("VIDEO_EVENTS"===i){const{videoEventName:e,payload:t}=r;this.sendVideoEvent(e,t)}}stopProcessingAudio(){this.featureEnabled=!1;(window.audioMonitor.audioInfos||[]).forEach(e=>{this.stopStream(e)})}}class H{static isYoutubeAd(){if(document?.querySelector("div.ad-showing"))return!0;const e=window?.location?.pathname?.includes("/shorts");return!(!e||!document?.querySelector("ytd-player.ytd-shorts div.ad-created"))}static delay(e){return new Promise(t=>setTimeout(t,e))}static extractGUIDFromURL(e){const t=e.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/);return t?`{${t[0]}}`:null}static getCacheKey(e){let t="";const i=document.location.href;try{t=new URL(i).origin}catch(e){return l.error(`[MB:getCacheKey] Failed to get cache key, err: ${e.message}`),i}let o=e||i;return("https://www.youtube.com"===t||"https://youtube.com"===t||o.startsWith("blob:"))&&(o=i),o}static isPlaying(e){return!(e.paused||e.ended||!(e.readyState>2))}static isStreamAlreadyStarted(e){const t=e.element.src||e.element.currentSrc;return!(e.src!==t||!e.capturing)&&(l.warn(`[MB:isStreamAlreadyStarted] monitor src:${e.src} is already being captured... so skipping`),!0)}}class K{constructor(e={}){this.uniqueMessageId=null,this.type={video:"video",canvas:"canvas"},this.onAudioFound=null,this.onAudioRemoved=null,this.onCanvasFound=null;const{video:t=!0,canvas:i=!0}=e;this.supported=[],t&&this.supported.push(this.type.video),i&&this.supported.push(this.type.canvas),this.processedElements=[]}init(e){if(this.uniqueMessageId=e,"function"!=typeof this.onAudioFound||"function"!=typeof this.onAudioRemoved)return void l.error("Please provide a callback function (onAudioFound / onAudioRemoved)");this.processDom(document.body),this.initDocumentListener(),l.log(`[MB:AudioRetriever] requesting initial shadow for id: ${this.uniqueMessageId}`);const t={detail:{command:E}},i=new CustomEvent(this.uniqueMessageId,g(t));document.dispatchEvent(i)}initDocumentListener(){document.addEventListener(`shadow_${this.uniqueMessageId}`,e=>{const{command:t,path:i}=e.detail;if(t!==A||!i)return void l.warn(`[MB:initDocumentListener] invalid or missing path/command, path=${i}`);const[o,r]=i.split("=");if(!o||!r)return void l.warn(`[MB:initDocumentListener] malformed path string, got attributeName=${o} ids=${r}`);const s=r.split(",");if(!Array.isArray(s)||0===s.length)return void l.warn("[MB:initDocumentListener] invalid path ID array (not array or length = 0)");const n=[];let a=document,d=null;try{for(const e of s){if(d=a.querySelector(`[${o}='${e}']`),!d)return void l.warn(`[MB:initDocumentListener] could not find hostNode for pathId: ${e}`);if(n.push(d),a=this.getShadowRoot(d),!a&&e!==s[s.length-1])return void l.error(`[MB:initDocumentListener] no shadowRoot found at path id: ${e}, while there are still paths to iterate to.`)}if(d.hasAttribute(y))return void l.warn("[MB:initDocumentListener] final hostNode already processed, skipping");d.setAttribute(y,"true"),l.log(`[MB:initDocumentListener] full path found for path=${i}`),this.processDom(a)}catch(e){l.error(`[MB:initDocumentListener] Error while processing shadow root path: ${e.message}`)}finally{for(const e of n)e.removeAttribute(o)}})}processDom(e){m(e,{addedNodeCb:this.handleAddedMutation.bind(this),removedNodeCb:this.handleRemovedMutation.bind(this)}),m(e,{attributeChangedCb:this.handleAttributeMutation.bind(this)},{attributeFilter:["src"]});const t=()=>{const t=this.findAudioElements(e);t.video.length>0||t.audio.length>0?(l.log(`[MB:processDom] Audio found when processing dom: video=${t.video.length}, audio=${t.audio.length}`),this.onAudioFound(t)):l.log("[MB:processDom] No audio found when processing dom."),t.canvas.length>0&&this.onCanvasFound(t.canvas)};t(),setTimeout(()=>{t()},1e3)}findAudioElements(e){const t={video:[],audio:[],canvas:[]},i=e=>e instanceof HTMLMediaElement&&!h(e,this.processedElements,{add:!0})?(t.video.push(e),!0):e instanceof HTMLAudioElement&&!h(e,this.processedElements,{add:!0})?(t.audio.push(e),!0):e instanceof HTMLCanvasElement&&!h(e,this.processedElements,{add:!0})&&(t.canvas.push(e),!0);if(!i(e)&&e?.querySelectorAll){const t=this.supported.join(","),o=e?.querySelectorAll(t)||[];Array.from(o).forEach(e=>i(e))}return t}handleAddedMutation(e){const t=this.findAudioElements(e);(t.video.length>0||t.audio.length>0)&&(l.log(`[MB:handleAddedMutation] Audio found from mutation observer: video=${t.video.length}, audio=${t.audio.length}`),this.onAudioFound&&this.onAudioFound(t)),t.canvas.length>0&&this.onCanvasFound&&this.onCanvasFound(t.canvas)}handleRemovedMutation(e){const t={video:[],audio:[]};if(e instanceof HTMLMediaElement&&h(e,this.processedElements)){window.audioMonitor.get(e).capturing=!1,t.video.push(e)}if(e instanceof HTMLAudioElement&&h(e,this.processedElements)){window.audioMonitor.get(e).capturing=!1,t.audio.push(e)}(t.video.length>0||t.audio.length>0)&&this.onAudioRemoved&&this.onAudioRemoved(t)}handleAttributeMutation(e){if(e.getAttribute("src")&&0!==e.offsetWidth&&0!==e.offsetHeight||this.handleRemovedMutation(e),e instanceof HTMLMediaElement&&h(e,this.processedElements)&&0===e.buffered.length){const t=((e,t)=>{if(!Array.isArray(t))return"";for(let i=0;i<t.length;i+=1)if(t[i].node.isSameNode(e))return t[i].url;return""})(e,this.processedElements);t!==window.location.href&&this.handleRemovedMutation(e)}}getShadowRoot(e){try{return chrome.dom?.openOrClosedShadowRoot?.(e)||e?.shadowRoot||null}catch{return null}}}class z{constructor(){this.audioProcessor=null,this.audioRetriever=null,this.featureEnabled=!0,this.socketDetails=null}init(e){this.socketDetails=e,this.initListeners(),this.initAudioProcessorAndRetriever(e)}initAudioProcessorAndRetriever(e){this.socketDetails=e;let t=!1;this.audioProcessor?t=!0:this.audioProcessor=new G,this.audioRetriever||(this.audioRetriever=new K,this.audioRetriever.onAudioFound=({video:e,audio:t})=>this.audioProcessor.handleAudioFound(e,t),this.audioRetriever.onAudioRemoved=({video:e,audio:t})=>this.audioProcessor.handleAudioRemoved(e,t),this.audioRetriever.onCanvasFound=e=>this.audioProcessor.handleCanvasFound(e)),this.audioProcessor.init(e,this.featureEnabled),this.audioRetriever.init(e.uniqueMessageId),this.featureEnabled&&t&&this.audioProcessor.streamPlayingAudio()}initListeners(){c(M,null,async({request:e,sendResponse:t})=>{const{command:i}=e;if(i===_){this.featureEnabled=e.dfdActive;let i={};this.featureEnabled?(i=await I(F),this.initAudioProcessorAndRetriever(i)):(i={uniqueMessageId:this.socketDetails.uniqueMessageId},this.audioProcessor.stopProcessingAudio());const o={detail:{command:_,featureEnabled:this.featureEnabled,newSocketDetails:i}},r=new CustomEvent(this.socketDetails.uniqueMessageId,g(o));return document?.dispatchEvent(r),t({content:!0}),!0}if(i===q){const i=this.audioProcessor.getStreamingAudios(e.id);if(i.find(e=>e.pageElement)){const e=f();document?.addEventListener(e,({detail:e})=>{e.streams&&e.streams.forEach(e=>{i.forEach(t=>{t.id===e.id&&(t.curtime=e.curtime)})}),l.log(`[MB:ContentProcessor] GET_STREAMING_AUDIOS: sent canvas message - received: ${JSON.stringify(i)}`),t({streams:i})}),l.log("[MB:ContentProcessor] GET_STREAMING_AUDIOS: sent canvas message.");const o={detail:{command:q,callbackId:e}},r=new CustomEvent(this.socketDetails.uniqueMessageId,g(o));document?.dispatchEvent(r)}else t({streams:i});return!0}if(i===U){l.log("[MB:ContentProcessor] STOP_STREAMING: command received.");const{videoId:i,srcUrl:o}=e,r=window.audioMonitor.getById(i);r?r?.element?.currentSrc===o?(l.log(`[MB:ContentProcessor] STOP_STREAMING: (${i}) calling stop stream on video id.`),r.stopstreamTriggered=!0):l.log(`[MB:ContentProcessor] STOP_STREAMING: (${i}) not tagged since currentSrc (${r?.element?.currentSrc}) is different than srcUrl(${o})`):l.log(`[MB:ContentProcessor] STOP_STREAMING: (${i}) monitoring item not found matching video id.`);const s={detail:{command:U,videoId:i,srcUrl:o}},n=new CustomEvent(this.socketDetails.uniqueMessageId,g(s));return document?.dispatchEvent(n),t(!0),!0}})}}(new class extends S{constructor(){super(V,M)}async start(){const e=await I(F);u(()=>{(new z).init(e)})}}).start()})();
//# sourceMappingURL=../../sourceMap/chrome/MockingBird-Package/scripts/mockingbird_content_main.js.map